rules = [
  DisableSyntax
]

# Exclude infrastructure files that legitimately need try-catch-finally
# for resource management, state restoration, or exception suppression
DisableSyntax.excludePackages = [
  "org.llm4s.core.safety",           # UsingOps needs try-finally for resource management
  "org.llm4s.agent.orchestration",   # MDCContext, CancellationToken, Policies need try-catch-finally
  # (removed dbx utils; keep list lean)
  "org.llm4s.config",                 # Allow ConfigFactory only here via ConfigReader
  "org.llm4s.samples",                # Samples/CLIs are application edge
  "org.llm4s.workspace"               # Workspace clients are also application edge
]

DisableSyntax {
  # Syntactic regex checks; no SemanticDB required
  regex = [
    {
      id = NoConfigFactory
      pattern = "\\bConfigFactory\\b"
      message = "Use PureConfig via Llm4sConfig at the app/test edge; do not call ConfigFactory directly."
    },
    {
      id = NoSysEnv
      pattern = "\\bsys\\.env\\b"
      message = "Read config via Llm4sConfig in app/test code; avoid sys.env in libraries."
    },
    {
      id = NoSystemGetenv
      pattern = "\\bSystem\\.getenv\\b"
      message = "Read config via Llm4sConfig in app/test code; avoid System.getenv in libraries."
    },
    {
      id = NoKeywordTry
      # Forbid the try {...} keyword form; allow scala.util.Try(...)
      pattern = "(?s)\\btry\\s*\\{"
      message = "Prefer scala.util.Try(...).toResult â€” import org.llm4s.types.TryOps"
    },
    {
      id = NoKeywordCatch
      pattern = "(?s)\\bcatch\\s*\\{"
      message = "Prefer mapping Result errors instead of catch; use Try(...).toResult and .left.map/.fold"
    },
    {
      id = NoKeywordFinally
      pattern = "(?s)\\bfinally\\b"
      message = "Prefer ManagedResource/Using or ensure cleanup via dedicated combinators"
    }
  ]
}

# ---- Scoped guards for main (non-test) core sources ----
# Forbid Llm4sConfig imports/refs in core main sources outside the config package
DisableSyntax.NoLlm4sConfig {
  fileFilter = "glob:modules/core/src/main/scala/**"
  excludePackages = ["org.llm4s.config"]
  regex = [
    {
      id = NoLlm4sConfigInCore
      pattern = "\\borg\\.llm4s\\.config\\.Llm4sConfig\\b|\\bimport\\s+org\\.llm4s\\.config\\.Llm4sConfig\\b"
      message = "Inject typed config at the app edge; avoid calling Llm4sConfig from core main sources."
    }
  ]
}

# Forbid direct PureConfig default reads in core main sources outside the config package
DisableSyntax.NoPureConfigDefault {
  fileFilter = "glob:modules/core/src/main/scala/**"
  excludePackages = ["org.llm4s.config"]
  regex = [
    {
      id = NoPureConfigDefaultInCore
      pattern = "\\bConfigSource\\.default\\b"
      message = "Inject typed config at the app edge; avoid direct PureConfig reads in core main sources."
    }
  ]
}

# Forbid sys.env/System.getenv in core main sources outside config
DisableSyntax.NoEnvReads {
  fileFilter = "glob:modules/core/src/main/scala/**"
  excludePackages = ["org.llm4s.config"]
  regex = [
    { id = NoSysEnvInCore, pattern = "\\bsys\\.env\\b", message = "Use typed config; avoid sys.env in core main sources." },
    { id = NoSystemGetenvInCore, pattern = "\\bSystem\\.getenv\\b", message = "Use typed config; avoid System.getenv in core main sources." }
  ]
}
