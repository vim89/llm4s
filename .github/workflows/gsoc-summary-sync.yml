name: GSoC Summary Sync Check

on:
  pull_request:
    paths:
      - 'Google Summer of Code/Project Ideas/2026.md'
  push:
    branches:
      - main
    paths:
      - 'Google Summer of Code/Project Ideas/2026.md'
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Scala CLI
        uses: VirtusLab/scala-cli-setup@main
        with:
          power: true
          
      - name: Regenerate summary
        run: |
          chmod +x scripts/GenerateGSoCSummary.scala
          scala-cli scripts/GenerateGSoCSummary.scala
          
      - name: Check for differences
        id: diff
        run: |
          if git diff --quiet "Google Summer of Code/GSOC-2026-SUMMARY.md"; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Summary is up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Summary needs update"
            echo ""
            echo "Changes detected:"
            git diff "Google Summer of Code/GSOC-2026-SUMMARY.md" | head -50
          fi
          
      - name: Commit updated summary (on main push)
        if: steps.diff.outputs.changed == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "Google Summer of Code/GSOC-2026-SUMMARY.md"
          git commit -m "chore: Auto-update GSoC 2026 summary from project ideas changes
          
          Regenerated by GitHub Actions after changes to Project Ideas/2026.md"
          git push
          
      - name: Comment on PR (if out of sync)
        if: steps.diff.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## GSoC Summary Out of Sync

The GSoC 2026 summary file needs to be regenerated after your changes to \`Project Ideas/2026.md\`.

**To fix:**
\`\`\`bash
scala-cli scripts/GenerateGSoCSummary.scala
git add "Google Summer of Code/GSOC-2026-SUMMARY.md"
git commit -m "Update GSoC summary"
\`\`\`

Or the summary will be automatically updated when this PR is merged to main.`
            })
          
      - name: Summary
        run: |
          if [ "${{ steps.diff.outputs.changed }}" == "true" ]; then
            if [ "${{ github.event_name }}" == "push" ]; then
              echo "Summary was out of sync and has been auto-updated"
            else
              echo "Summary is out of sync - please regenerate or it will be auto-updated on merge"
            fi
          else
            echo "Summary is synchronized with project ideas"
          fi
